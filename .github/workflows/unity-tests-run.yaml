name: Unity EditMode Tests

on:
  issue_comment:
    types: [created]
  push:
    branches: [main]
    paths:
      - "Packages/com.playroomkit.sdk/**/*.cs"
      - "Packages/com.playroomkit.sdk/**/*.asmdef"
      - "Packages/com.playroomkit.sdk/**/*.asmref"
      - "Packages/com.playroomkit.sdk/**/*.unity"
      - "Packages/com.playroomkit.sdk/package.json"

concurrency:
  group: unity-tests-${{ github.event.issue.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write
  pull-requests: write
  issues: write

jobs:
  resolve-pr:
    if: github.event_name == 'issue_comment'
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.resolve.outputs.should_run }}
      pr_number: ${{ steps.resolve.outputs.pr_number }}
      sha: ${{ steps.resolve.outputs.sha }}
      head_repo: ${{ steps.resolve.outputs.head_repo }}
      comment_id: ${{ steps.resolve.outputs.comment_id }}
    steps:
      - name: Resolve PR from comment
        id: resolve
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.comment.body || "";
            const command = "/run-unity-tests";
            if (!body.trim().startsWith(command)) {
              core.setOutput("should_run", "false");
              return;
            }

            if (!context.payload.issue.pull_request) {
              core.setOutput("should_run", "false");
              return;
            }

            const allowed = ["OWNER", "MEMBER", "COLLABORATOR"];
            if (!allowed.includes(context.payload.comment.author_association)) {
              core.setOutput("should_run", "false");
              return;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.issue.number;
            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: prNumber,
            });

            core.setOutput("should_run", "true");
            core.setOutput("pr_number", String(prNumber));
            core.setOutput("sha", pr.head.sha);
            core.setOutput("head_repo", pr.head.repo.full_name);
            core.setOutput("comment_id", String(context.payload.comment.id));

  unity-tests-pr:
    if: github.event_name == 'issue_comment' && needs.resolve-pr.outputs.should_run == 'true'
    needs: resolve-pr
    runs-on: ubuntu-latest
    environment: unity-ci
    steps:
      - name: Mark Unity tests as running
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = "${{ needs.resolve-pr.outputs.sha }}";
            const prNumber = Number("${{ needs.resolve-pr.outputs.pr_number }}");
            const commentId = Number("${{ needs.resolve-pr.outputs.comment_id }}");

            const labelPending = "unity-test: pending";
            const labelPassed = "unity-test: passed";
            const labelFailed = "unity-test: failed";
            const commentTag = "<!-- unity-tests-gate -->";
            const checkName = "EditMode Test Results";
            const body = [
              commentTag,
              "### Unity EditMode Tests",
              "**Status:** running",
              "Triggered by a member/collaborator.",
            ].join("\n");

            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner,
              repo,
              ref: sha,
              check_name: checkName,
              per_page: 1,
            });

            if (checkRuns.total_count > 0) {
              await github.rest.checks.update({
                owner,
                repo,
                check_run_id: checkRuns.check_runs[0].id,
                status: "in_progress",
                output: {
                  title: "EditMode Test Results - Running",
                  summary: "Unity tests are running.",
                },
              });
            } else {
              await github.rest.checks.create({
                owner,
                repo,
                name: checkName,
                head_sha: sha,
                status: "in_progress",
                output: {
                  title: "EditMode Test Results - Running",
                  summary: "Unity tests are running.",
                },
              });
            }

            await github.rest.reactions.createForIssueComment({
              owner,
              repo,
              comment_id: commentId,
              content: "eyes",
            });

            for (const label of [labelPassed, labelFailed]) {
              try {
                await github.rest.issues.removeLabel({
                  owner,
                  repo,
                  issue_number: prNumber,
                  name: label,
                });
              } catch (error) {
                if (error.status !== 404) {
                  throw error;
                }
              }
            }

            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: prNumber,
              labels: [labelPending],
            });

            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: prNumber,
              per_page: 100,
            });

            const existing = comments.find((comment) =>
              comment.body && comment.body.includes(commentTag)
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body,
              });
            }

      - uses: actions/checkout@v4
        with:
          lfs: true
          repository: ${{ needs.resolve-pr.outputs.head_repo }}
          ref: ${{ needs.resolve-pr.outputs.sha }}

      - name: Run EditMode tests
        uses: game-ci/unity-test-runner@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          projectPath: Packages/com.playroomkit.sdk
          packageMode: true
          unityVersion: 2022.3.62f3
          testMode: editmode
          artifactsPath: Assets/test-results
          githubToken: ${{ github.token }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unity-test-results
          path: Assets/test-results

      - name: Summarize test results
        if: always()
        id: summarize
        shell: bash
        run: |
          python - <<'PY'
          import os
          import xml.etree.ElementTree as ET

          path = "Assets/test-results/editmode-results.xml"
          total = passed = failed = skipped = 0
          duration = "unknown"
          summary = "Results file not found."

          if os.path.exists(path):
            try:
              tree = ET.parse(path)
              root = tree.getroot()
              total = root.attrib.get("total", total)
              passed = root.attrib.get("passed", passed)
              failed = root.attrib.get("failed", failed)
              skipped = root.attrib.get("skipped", skipped)
              duration = root.attrib.get("duration", duration)
              summary = (
                f"Total: {total} | Passed: {passed} | Failed: {failed} "
                f"| Skipped: {skipped} | Duration: {duration}s"
              )
            except Exception:
              summary = "Results file present but failed to parse."

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
            f.write(f"summary={summary}\n")
          PY

      - name: Update PR status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = "${{ needs.resolve-pr.outputs.sha }}";
            const prNumber = Number("${{ needs.resolve-pr.outputs.pr_number }}");
            const commentId = Number("${{ needs.resolve-pr.outputs.comment_id }}");
            const conclusion = "${{ job.status }}";

            const labelPending = "unity-test: pending";
            const labelPassed = "unity-test: passed";
            const labelFailed = "unity-test: failed";
            const commentTag = "<!-- unity-tests-gate -->";
            const statusLine =
              conclusion === "success"
                ? "Unity EditMode tests passed."
                : "Unity EditMode tests failed.";
            const body = [
              commentTag,
              "### Unity EditMode Tests",
              `**Status:** ${conclusion === "success" ? "passed" : "failed"}`,
              statusLine,
              "Manual rerun: `/run-unity-tests`",
            ].join("\n");

            await github.rest.reactions.createForIssueComment({
              owner,
              repo,
              comment_id: commentId,
              content: conclusion === "success" ? "hooray" : "confused",
            });

            try {
              await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number: prNumber,
                name: labelPending,
              });
            } catch (error) {
              if (error.status !== 404) {
                throw error;
              }
            }

            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: prNumber,
              labels: [conclusion === "success" ? labelPassed : labelFailed],
            });

            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: prNumber,
              per_page: 100,
            });

            const existing = comments.find((comment) =>
              comment.body && comment.body.includes(commentTag)
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body,
              });
            }

      - name: Update check run summary
        if: always()
        uses: actions/github-script@v7
        env:
          SUMMARY: ${{ steps.summarize.outputs.summary }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = "${{ needs.resolve-pr.outputs.sha }}";
            const conclusion = "${{ job.status }}";
            const summary = process.env.SUMMARY || "Summary unavailable.";
            const checkName = "EditMode Test Results";

            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner,
              repo,
              ref: sha,
              check_name: checkName,
              per_page: 1,
            });

            const payload = {
              owner,
              repo,
              status: "completed",
              conclusion: conclusion === "success" ? "success" : "failure",
              output: {
                title:
                  conclusion === "success"
                    ? "EditMode Test Results - Passed"
                    : "EditMode Test Results - Failed",
                summary: summary,
                text: `Run: ${context.serverUrl}/${owner}/${repo}/actions/runs/${context.runId}`,
              },
            };

            if (checkRuns.total_count > 0) {
              await github.rest.checks.update({
                ...payload,
                check_run_id: checkRuns.check_runs[0].id,
              });
            } else {
              await github.rest.checks.create({
                ...payload,
                name: checkName,
                head_sha: sha,
              });
            }

  unity-tests-main:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: unity-ci
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Run EditMode tests
        uses: game-ci/unity-test-runner@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          projectPath: Packages/com.playroomkit.sdk
          packageMode: true
          unityVersion: 2022.3.62f3
          testMode: editmode
          artifactsPath: Assets/test-results
          githubToken: ${{ github.token }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unity-test-results
          path: Assets/test-results

      - name: Summarize test results
        if: always()
        id: summarize
        shell: bash
        run: |
          python - <<'PY'
          import os
          import xml.etree.ElementTree as ET

          path = "Assets/test-results/editmode-results.xml"
          total = passed = failed = skipped = 0
          duration = "unknown"
          summary = "Results file not found."

          if os.path.exists(path):
            try:
              tree = ET.parse(path)
              root = tree.getroot()
              total = root.attrib.get("total", total)
              passed = root.attrib.get("passed", passed)
              failed = root.attrib.get("failed", failed)
              skipped = root.attrib.get("skipped", skipped)
              duration = root.attrib.get("duration", duration)
              summary = (
                f"Total: {total} | Passed: {passed} | Failed: {failed} "
                f"| Skipped: {skipped} | Duration: {duration}s"
              )
            except Exception:
              summary = "Results file present but failed to parse."

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
            f.write(f"summary={summary}\n")
          PY

      - name: Publish check run summary
        if: always()
        uses: actions/github-script@v7
        env:
          SUMMARY: ${{ steps.summarize.outputs.summary }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.sha;
            const conclusion = "${{ job.status }}";
            const summary = process.env.SUMMARY || "Summary unavailable.";

            await github.rest.checks.create({
              owner,
              repo,
              name: "EditMode Test Results",
              head_sha: sha,
              status: "completed",
              conclusion: conclusion === "success" ? "success" : "failure",
              output: {
                title:
                  conclusion === "success"
                    ? "EditMode Test Results - Passed"
                    : "EditMode Test Results - Failed",
                summary: summary,
                text: `Run: ${context.serverUrl}/${owner}/${repo}/actions/runs/${context.runId}`,
              },
            });
