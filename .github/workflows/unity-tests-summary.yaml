name: Unity Test Summary

on:
  workflow_run:
    workflows: ["Unity EditMode Tests"]
    types: [completed]

permissions:
  actions: read
  contents: read
  checks: write

concurrency:
  group: unity-tests-summary-${{ github.event.workflow_run.id }}
  cancel-in-progress: true

jobs:
  summarize:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch test results artifact
        id: artifact
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const runId = context.payload.workflow_run.id;
            const { data } = await github.rest.actions.listWorkflowRunArtifacts({
              owner,
              repo,
              run_id: runId,
            });
            const artifact = data.artifacts.find(
              (item) => item.name === "unity-test-results"
            );
            if (!artifact) {
              core.setOutput("artifact_url", "");
              return;
            }
            core.setOutput("artifact_url", artifact.archive_download_url);

      - name: Download and extract results
        if: steps.artifact.outputs.artifact_url != ''
        shell: bash
        run: |
          curl -L \
            -H "Authorization: token ${{ github.token }}" \
            -H "Accept: application/vnd.github+json" \
            -o /tmp/unity-test-results.zip \
            "${{ steps.artifact.outputs.artifact_url }}"
          unzip -o /tmp/unity-test-results.zip -d /tmp/unity-test-results

      - name: Publish test report
        if: steps.artifact.outputs.artifact_url != ''
        uses: dorny/test-reporter@v1
        with:
          name: EditMode Test Results
          path: /tmp/unity-test-results/Assets/test-results/editmode-results.xml
          reporter: nunit
          fail-on-error: false

      - name: Update gate check
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.payload.workflow_run.head_sha;
            const runId = context.payload.workflow_run.id;
            const conclusion = context.payload.workflow_run.conclusion || "neutral";
            const gateCheckName = "Unity Tests Gate";

            const conclusionMap = new Map([
              ["success", "success"],
              ["failure", "failure"],
              ["cancelled", "cancelled"],
              ["timed_out", "timed_out"],
              ["skipped", "skipped"],
              ["action_required", "action_required"],
            ]);
            const mappedConclusion = conclusionMap.get(conclusion) || "neutral";

            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner,
              repo,
              ref: sha,
              check_name: gateCheckName,
              per_page: 1,
            });

            const payload = {
              owner,
              repo,
              status: "completed",
              conclusion: mappedConclusion,
              output: {
                title:
                  mappedConclusion === "success"
                    ? "Unity Tests Gate - Passed"
                    : "Unity Tests Gate - Failed",
                summary: "Manual Unity tests completed.",
                text: `Run: ${context.serverUrl}/${owner}/${repo}/actions/runs/${runId}`,
              },
            };

            if (checkRuns.total_count > 0) {
              await github.rest.checks.update({
                ...payload,
                check_run_id: checkRuns.check_runs[0].id,
              });
            } else {
              await github.rest.checks.create({
                ...payload,
                name: gateCheckName,
                head_sha: sha,
              });
            }
